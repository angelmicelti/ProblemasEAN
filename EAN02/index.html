<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Te reto con las resistencias</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #007bff;
            --bg-color: #f4f6f9;
            --card-bg: #ffffff;
            --success-color: #28a745;
            --success-bg: #d4edda;
            --error-color: #dc3545;
            --error-bg: #ffeef0;
            --warning-color: #fd7e14;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; padding: 20px; background-color: var(--bg-color); color: #333; line-height: 1.6;
        }

        .container { 
            max-width: 1100px; width: 100%; margin: auto; background: var(--card-bg); 
            padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); box-sizing: border-box;
        }

        h1 { 
            color: var(--primary-color); text-align: center; border-bottom: 2px solid #eee; 
            padding-bottom: 15px; margin-bottom: 20px; font-size: 1.8rem;
        }
        
        /* --- CONTROLES --- */
        .controls { 
            background: #e9ecef; padding: 20px; border-radius: 10px; margin-bottom: 25px; 
            text-align: center; display: flex; flex-direction: column; align-items: center; 
            gap: 15px; border: 1px solid #dee2e6; 
        }

        .radio-group { 
            background: white; padding: 10px 20px; border-radius: 20px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; 
            justify-content: center; gap: 10px;
        }
        .radio-group label { margin: 0 5px; font-weight: bold; cursor: pointer; color: #495057; display: flex; align-items: center; }
        input[type="radio"] { transform: scale(1.3); margin-right: 8px; cursor: pointer; }

        .btn-report {
            background-color: var(--primary-color); color: white; border: none; padding: 12px 25px;
            border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: bold;
            transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 300px;
        }
        .btn-report:hover { background-color: #1a252f; transform: translateY(-2px); }

        /* --- TABLA --- */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        
        th { 
            background-color: var(--primary-color); color: white; padding: 15px; position: sticky; 
            top: 0; z-index: 10; font-weight: 600; letter-spacing: 0.5px; 
        }
        th:first-child { border-top-left-radius: 8px; }
        th:last-child { border-top-right-radius: 8px; }
        
        td { 
            border-bottom: 1px solid #dee2e6; padding: 12px 8px; text-align: center; 
            vertical-align: middle; background: #fff; transition: background 0.3s;
        }
        tr:hover td { background-color: #f8f9fa; }

        /* ESTILOS DE ESTADO DE FILA */
        tr.row-cheated td { background-color: #fff3cd; } 
        tr.row-failed td { background-color: var(--error-bg); } 
        tr.row-solved td { background-color: var(--success-bg); }

        /* --- RESISTENCIA GR√ÅFICA --- */
        .resistor-graphic { display: flex; align-items: center; justify-content: center; width: 100%; }
        .band-container { 
            display: flex; justify-content: center; align-items: center; gap: 8px;
            background: #e8cc8d; padding: 6px 16px; border-radius: 30px; 
            border: 3px solid #c9b078; box-shadow: inset 0 -4px 6px rgba(0,0,0,0.1); 
            max-width: 100%;
        }
        .color-box { 
            width: 14px; height: 38px; border-top: 1px solid rgba(255,255,255,0.4); 
            border-bottom: 1px solid rgba(0,0,0,0.2); cursor: help; transition: transform 0.1s;
        }
        .color-box:hover { transform: scale(1.1); }
        .wire { display: inline-block; width: 25px; height: 3px; background: #999; }

        /* --- INTERACCI√ìN --- */
        select, input[type="number"] {
            padding: 8px; border: 1px solid #ced4da; border-radius: 4px; margin: 2px; font-size: 16px; 
        }
        input[type="number"] { width: 80px; text-align: right; }
        
        .color-select { width: auto; min-width: 80px; } 
        
        .interactive-area { display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 5px; }

        .btn-check {
            background-color: var(--accent-color); color: white; border: none; padding: 8px 16px;
            border-radius: 4px; cursor: pointer; margin-left: 5px; font-size: 0.95em; font-weight: 600;
        }
        .btn-check:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-check:hover:not(:disabled) { background-color: #0056b3; }
        
        /* Feedback */
        .feedback-container { min-height: 24px; margin-top: 6px; width: 100%; text-align: center; display: block; }
        .feedback { font-weight: bold; font-size: 0.9em; transition: opacity 0.5s; opacity: 1; display: inline-block; }
        
        .correct { color: var(--success-color); }
        .incorrect { color: var(--error-color); }
        .info { color: var(--error-color); } 
        
        .viewed-msg { color: var(--warning-color); font-size: 0.85em; font-weight: bold; }

        .fade-out { opacity: 0; }
        .hidden { display: none !important; }

        .val-text { font-weight: bold; color: #0056b3; font-size: 1.2em; }
        .current-text { color: var(--success-color); font-weight: bold; font-family: monospace; font-size: 1.1em; }
        
        input[type="checkbox"].sol-check { transform: scale(1.5); cursor: pointer; accent-color: var(--warning-color); }
        input[type="checkbox"].sol-check.solved { accent-color: var(--success-color); pointer-events: none; }
        input[type="checkbox"].sol-check.failed { accent-color: var(--error-color); cursor: not-allowed; opacity: 0.6; }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            h1 { font-size: 1.5rem; }
            thead { display: none; }
            tr {
                display: flex; flex-direction: column; background: white; margin-bottom: 20px;
                border: 1px solid #e0e0e0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 15px;
            }
            td { display: block; width: 100%; box-sizing: border-box; padding: 10px 0; text-align: center; border-bottom: none; }
            td:nth-of-type(1) { border-bottom: 1px solid #f0f0f0; margin-bottom: 10px; font-weight: bold; color: #888; }
            td:nth-of-type(1)::before { content: "Ejercicio #"; }
            td:nth-of-type(2)::before { content: "Valor:"; display: block; font-weight: bold; color: #555; margin-bottom: 5px; font-size: 0.9em; }
            td:nth-of-type(3)::before { content: "Bandas de Color:"; display: block; font-weight: bold; color: #555; margin-bottom: 8px; font-size: 0.9em; }
            .interactive-area { flex-direction: column; width: 100%; }
            select, input[type="number"], .btn-check { width: 90%; max-width: 100%; margin: 5px 0; }
            .color-select { width: 90%; }
            td:nth-of-type(5) { border-top: 1px solid #f0f0f0; padding-top: 15px; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
            td:nth-of-type(5)::before { content: "Soluci√≥n:"; font-weight: bold; color: #333; }
            td:nth-of-type(4) { order: 6; padding-top: 0; }
        }

        /* --- MODAL INFORME --- */
        #reportModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; backdrop-filter: blur(3px); padding: 20px; box-sizing: border-box; }
        .modal-content { background-color: white; padding: 0; border-radius: 15px; width: 100%; max-width: 450px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { background: var(--primary-color); color: white; padding: 20px; }
        .modal-body { padding: 25px; }
        .stat-row { margin-bottom: 20px; text-align: left; }
        .stat-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.9em; }
        .progress-bg { background: #e9ecef; height: 12px; border-radius: 6px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--success-color); width: 0%; transition: width 1s ease-in-out; }
        .bar-cheated { background: var(--warning-color); }
        .bar-failed { background: var(--error-color); }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .mini-stat { background: #f8f9fa; padding: 10px; border-radius: 8px; }
        .mini-stat .num { display: block; font-size: 1.4em; font-weight: bold; color: #333; }
        .mini-stat .desc { font-size: 0.8em; color: #666; }
        .close-btn { margin: 0 0 25px 0; background: #6c757d; color: white; border: none; padding: 12px 30px; border-radius: 20px; cursor: pointer; width: 80%; }
        .close-btn:hover { background: #5a6268; }
    </style>
</head>
<body>

<div class="container">
    <h1>‚ö° Te reto con las resistencias</h1>
    
    <div class="controls">
        <div class="radio-group">
            <label><input type="radio" name="mode" value="colores" id="modeCol" checked onchange="handleModeChange()"> Adivinar colores</label>
            <label><input type="radio" name="mode" value="resistencia" id="modeRes" onchange="handleModeChange()"> Adivinar valores</label>
        </div>
        
        <button class="btn-report" onclick="showReport()">üìä Ver Informe de Progreso</button>

        <p style="margin: 5px 0 0 0; color:#666; font-size:0.85em;">
            <em><strong>Nota:</strong> Solo tienes 1 intento. El progreso se conserva para cada resistencia.</em>
        </p>
    </div>

    <table id="exerciseTable">
        <thead>
            <tr>
                <th width="5%">#</th>
                <th width="35%">Valor (&Omega;)</th>
                <th width="45%">Bandas de Color</th>
                <th width="10%">Corriente</th>
                <th width="5%">Sol.</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>
</div>

<div id="reportModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Informe de Resultados</h2>
        </div>
        <div class="modal-body">
            <div class="stat-row">
                <div class="stat-label">
                    <span>Aciertos</span>
                    <span id="txt-progress">0/0</span>
                </div>
                <div class="progress-bg">
                    <div class="progress-bar" id="bar-progress"></div>
                </div>
            </div>
             <div class="stat-row">
                <div class="stat-label">
                    <span>Fallados (Incorrectos)</span>
                    <span id="txt-failed">0</span>
                </div>
                <div class="progress-bg">
                    <div class="progress-bar bar-failed" id="bar-failed" style="width: 0%"></div>
                </div>
            </div>
            <div class="stat-row">
                <div class="stat-label">
                    <span>Vistos (Sin intentar)</span>
                    <span id="txt-cheated">0</span>
                </div>
                <div class="progress-bg">
                    <div class="progress-bar bar-cheated" id="bar-cheated" style="width: 0%"></div>
                </div>
            </div>

            <div class="stat-grid">
                <div class="mini-stat">
                    <span class="num" id="val-completed" style="color: var(--success-color);">0</span>
                    <span class="desc">Aciertos</span>
                </div>
                <div class="mini-stat">
                    <span class="num" id="val-failed" style="color: var(--error-color);">0</span>
                    <span class="desc">Fallos</span>
                </div>
                <div class="mini-stat">
                    <span class="num" id="val-viewed" style="color: var(--warning-color);">0</span>
                    <span class="desc">Vistos</span>
                </div>
                <div class="mini-stat">
                    <span class="num" id="val-pending" style="color: #6c757d;">0</span>
                    <span class="desc">Pendientes</span>
                </div>
            </div>
        </div>
        <button class="close-btn" onclick="closeReport()">Cerrar Informe</button>
    </div>
</div>

<script>
/* DATOS SERIE E6 */
const exercises = [
    { v: "10", r: 10, b: ["MArr√≥n", "NEgro", "NEgro"] },
    { v: "15", r: 15, b: ["MArr√≥n", "VERde", "NEgro"] },
    { v: "22", r: 22, b: ["ROjo", "ROjo", "NEgro"] },
    { v: "33", r: 33, b: ["NAranja", "NAranja", "NEgro"] },
    { v: "47", r: 47, b: ["AMarillo", "VIOleta", "NEgro"] },
    { v: "68", r: 68, b: ["AZul", "GRIs", "NEgro"] },
    { v: "100", r: 100, b: ["MArr√≥n", "NEgro", "MArr√≥n"] },
    { v: "150", r: 150, b: ["MArr√≥n", "VERde", "MArr√≥n"] },
    { v: "220", r: 220, b: ["ROjo", "ROjo", "MArr√≥n"] },
    { v: "330", r: 330, b: ["NAranja", "NAranja", "MArr√≥n"] },
    { v: "470", r: 470, b: ["AMarillo", "VIOleta", "MArr√≥n"] },
    { v: "680", r: 680, b: ["AZul", "GRIs", "MArr√≥n"] },
    { v: "1 K", r: 1000, b: ["MArr√≥n", "NEgro", "ROjo"] },
    { v: "1.5 K", r: 1500, b: ["MArr√≥n", "VERde", "ROjo"] },
    { v: "2.2 K", r: 2200, b: ["ROjo", "ROjo", "ROjo"] },
    { v: "3.3 K", r: 3300, b: ["NAranja", "NAranja", "ROjo"] },
    { v: "4.7 K", r: 4700, b: ["AMarillo", "VIOleta", "ROjo"] },
    { v: "6.8 K", r: 6800, b: ["AZul", "GRIs", "ROjo"] },
    { v: "10 K", r: 10000, b: ["MArr√≥n", "NEgro", "NAranja"] },
    { v: "15 K", r: 15000, b: ["MArr√≥n", "VERde", "NAranja"] },
    { v: "22 K", r: 22000, b: ["ROjo", "ROjo", "NAranja"] },
    { v: "33 K", r: 33000, b: ["NAranja", "NAranja", "NAranja"] },
    { v: "47 K", r: 47000, b: ["AMarillo", "VIOleta", "NAranja"] },
    { v: "68 K", r: 68000, b: ["AZul", "GRIs", "NAranja"] },
    { v: "100 K", r: 100000, b: ["MArr√≥n", "NEgro", "AMarillo"] },
    { v: "150 K", r: 150000, b: ["MArr√≥n", "VERde", "AMarillo"] },
    { v: "220 K", r: 220000, b: ["ROjo", "ROjo", "AMarillo"] },
    { v: "330 K", r: 330000, b: ["NAranja", "NAranja", "AMarillo"] },
    { v: "470 K", r: 470000, b: ["AMarillo", "VIOleta", "AMarillo"] },
    { v: "680 K", r: 680000, b: ["AZul", "GRIs", "AMarillo"] },
    { v: "1 M", r: 1000000, b: ["MArr√≥n", "NEgro", "VERde"] },
    { v: "1.5 M", r: 1500000, b: ["MArr√≥n", "VERde", "VERde"] },
    { v: "2.2 M", r: 2200000, b: ["ROjo", "ROjo", "VERde"] },
    { v: "3.3 M", r: 3300000, b: ["NAranja", "NAranja", "VERde"] },
    { v: "4.7 M", r: 4700000, b: ["AMarillo", "VIOleta", "VERde"] },
    { v: "6.8 M", r: 6800000, b: ["AZul", "GRIs", "VERde"] },
    { v: "10 M", r: 10000000, b: ["MArr√≥n", "NEgro", "AZul"] },
    { v: "15 M", r: 15000000, b: ["MArr√≥n", "VERde", "AZul"] },
    { v: "22 M", r: 22000000, b: ["ROjo", "ROjo", "AZul"] },
    { v: "33 M", r: 33000000, b: ["NAranja", "NAranja", "AZul"] },
    { v: "1 K", r: 1000, b: ["MArr√≥n", "NEgro", "ROjo"] },
    { v: "10 K", r: 10000, b: ["MArr√≥n", "NEgro", "NAranja"] },
    { v: "100", r: 100, b: ["MArr√≥n", "NEgro", "MArr√≥n"] },
    { v: "220", r: 220, b: ["ROjo", "ROjo", "MArr√≥n"] },
    { v: "4.7 K", r: 4700, b: ["AMarillo", "VIOleta", "ROjo"] },
    { v: "330", r: 330, b: ["NAranja", "NAranja", "MArr√≥n"] },
    { v: "1 M", r: 1000000, b: ["MArr√≥n", "NEgro", "VERde"] },
    { v: "10", r: 10, b: ["MArr√≥n", "NEgro", "NEgro"] },
    { v: "2.2 K", r: 2200, b: ["ROjo", "ROjo", "ROjo"] },
    { v: "470 K", r: 470000, b: ["AMarillo", "VIOleta", "AMarillo"] }
];

exercises.forEach((ex, i) => ex.id = i);

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}
shuffle(exercises);

const colorList = ["NEgro", "MArr√≥n", "ROjo", "NAranja", "AMarillo", "VERde", "AZul", "VIOleta", "GRIs", "BLAnco", "ORO", "PLATA"];
const colorMap = {
    "NEgro": "#000000", "MArr√≥n": "#8B4513", "ROjo": "#DC143C", "NAranja": "#FF8C00", 
    "AMarillo": "#FFD700", "VERde": "#228B22", "AZul": "#0000CD", "VIOleta": "#8A2BE2", 
    "GRIs": "#808080", "BLAnco": "#F5F5F5", "ORO": "#D4AF37", "PLATA": "#C0C0C0"
};

let stats = {
    totalClicks: 0,
    successfulClicks: 0,
    solvedTasks: new Set(), 
    viewedTasks: new Set(),
    failedTasks: new Set(),
    attemptedTasks: new Set()
};

const TOTAL_TASKS = exercises.length; 

function getCurrentMode() {
    return document.querySelector('input[name="mode"]:checked').value;
}

function handleModeChange() {
    shuffle(exercises);
    renderTable();
}

function formatCurrent(r) {
    const volts = 9;
    const amps = volts / r;
    if (amps < 0.000001) return (amps * 1000000000).toFixed(2) + " nA";
    else if (amps < 0.001) return (amps * 1000000).toFixed(2) + " ŒºA";
    else return (amps * 1000).toFixed(2) + " mA";
}

function renderTable() {
    const mode = getCurrentMode();
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';

    exercises.forEach((ex, i) => {
        const tr = document.createElement('tr');
        
        const taskKey = ex.id; 
        
        const isSolved = stats.solvedTasks.has(taskKey);
        const isViewed = stats.viewedTasks.has(taskKey);
        const isFailed = stats.failedTasks.has(taskKey);
        
        if(isViewed) tr.classList.add('row-cheated');
        if(isFailed) tr.classList.add('row-failed'); 
        if(isSolved) tr.classList.add('row-solved'); 

        const showSolutionStatic = isSolved || isViewed || isFailed;
        const inputDisabled = showSolutionStatic ? 'disabled' : '';
        const feedbackId = `fb-${i}`; 

        let valContent = '';
        if (mode === 'resistencia') {
            if (!showSolutionStatic) {
                valContent = `
                    <div class="interactive-area" id="input-val-${i}">
                        <input type="number" id="user-num-${i}" step="0.01" placeholder="Valor" ${inputDisabled}>
                        <select id="user-unit-${i}" ${inputDisabled}>
                            <option value="1">Œ©</option>
                            <option value="1000">KŒ©</option>
                            <option value="1000000">MŒ©</option>
                        </select>
                        <button class="btn-check" onclick="checkValue(${i})">Comprobar</button>
                    </div>
                    <div class="feedback-container"><span class="feedback" id="${feedbackId}"></span></div>
                `;
            } else {
                let feedbackText = "";
                let feedbackClass = "";
                if (isViewed) { feedbackText = "(Vista Soluci√≥n)"; feedbackClass = "viewed-msg"; }
                
                valContent = `
                    <span class="val-text">${ex.v}</span> 
                    <div class="feedback-container">
                        <span class="feedback ${feedbackClass}" id="${feedbackId}">${feedbackText}</span>
                    </div>
                `;
            }
        } else {
            valContent = `<span class="val-text">${ex.v}</span>`;
        }

        let colContent = '';
        let bandsHtml = `<div class="wire"></div>`;
        ex.b.forEach((c, idx) => bandsHtml += `<div class="color-box" style="background-color:${colorMap[c]}" title="Banda ${idx+1}: ${c}"></div>`);
        bandsHtml += `<div class="color-box" style="background-color:${colorMap['ORO']}" title="Tol: 5%"></div><div class="wire"></div>`;
        const staticResistor = `<div class="resistor-graphic"><div class="band-container">${bandsHtml}</div></div>`;

        if (mode === 'colores') {
            if (!showSolutionStatic) {
                 let dropdowns = '';
                for(let b=0; b<3; b++) {
                    let limit = (b === 2) ? 7 : 10; 
                    let options = `<option value="">-</option>` + colorList.slice(0,limit).map(c => `<option value="${c}">${c}</option>`).join('');
                    dropdowns += `<select class="color-select" id="user-col-${i}-${b}" ${inputDisabled}>${options}</select>`;
                }
                colContent = `
                    <div class="interactive-area" id="input-col-${i}">
                        ${dropdowns} <button class="btn-check" onclick="checkColors(${i})">Comprobar</button>
                    </div>
                    <div class="feedback-container"><span class="feedback" id="${feedbackId}"></span></div>
                `;
            } else {
                let feedbackText = "";
                let feedbackClass = "";
                if (isViewed) { feedbackText = "(Vista Soluci√≥n)"; feedbackClass = "viewed-msg"; }

                colContent = `
                    ${staticResistor} 
                    <div class="feedback-container">
                        <span class="feedback ${feedbackClass}" id="${feedbackId}">${feedbackText}</span>
                    </div>
                `;
            }
        } else {
            colContent = staticResistor;
        }

        let checkState = '';
        let checkClass = 'sol-check';
        let checkOnChange = `onchange="toggleManualSolution(${i})"`;
        
        if (isSolved) {
            checkState = 'checked disabled'; 
            checkClass += ' solved';
        } else if (isFailed) {
            checkState = 'disabled';
            checkClass += ' failed';
        } else if (isViewed) {
            checkState = 'checked';
        }

        const showCurrent = (isSolved || isViewed || isFailed);
        const currClass = showCurrent ? 'current-text' : 'current-text hidden';
        const currVal = formatCurrent(ex.r);

        tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${valContent}</td>
            <td>${colContent}</td>
            <td><span class="${currClass}" id="curr-${i}">${currVal}</span></td>
            <td><input type="checkbox" class="${checkClass}" id="check-${i}" ${checkState} ${checkOnChange}></td>
        `;
        tbody.appendChild(tr);
    });
}

function registerAction(exerciseId, resultType) {
    const taskKey = exerciseId; 
    
    if (stats.solvedTasks.has(taskKey) || stats.failedTasks.has(taskKey) || stats.viewedTasks.has(taskKey)) return;

    stats.totalClicks++;
    stats.attemptedTasks.add(taskKey);

    if (resultType === 'success') {
        stats.successfulClicks++;
        stats.solvedTasks.add(taskKey);
    } else if (resultType === 'failure') {
        stats.failedTasks.add(taskKey); 
    }
}

function toggleManualSolution(idx) {
    const exerciseId = exercises[idx].id;
    const checkbox = document.getElementById(`check-${idx}`);
    const taskKey = exerciseId;

    if (checkbox.checked) {
        if (!stats.solvedTasks.has(taskKey) && !stats.failedTasks.has(taskKey)) {
            stats.viewedTasks.add(taskKey);
            stats.attemptedTasks.add(taskKey); 
            renderTable();
        } 
    } else {
        renderTable(); 
    }
}

function checkValue(idx) {
    const exerciseId = exercises[idx].id;
    const valInput = document.getElementById(`user-num-${idx}`);
    const userUnit = parseFloat(document.getElementById(`user-unit-${idx}`).value);
    const feedbackElem = document.getElementById(`fb-${idx}`);

    if (!valInput.value || valInput.value.trim() === "") { 
        showFeedback(feedbackElem, "Introduce un valor", "info", 2000); 
        return; 
    }
    const userNum = parseFloat(valInput.value);
    if (isNaN(userNum)) {
         showFeedback(feedbackElem, "Valor no v√°lido", "info", 2000);
         return;
    }

    const userTotal = userNum * userUnit;
    const target = exercises[idx].r;
    
    if (Math.abs(userTotal - target) <= 0.05 * target + 0.1) { 
        registerAction(exerciseId, 'success');
        renderTable(); 
        showFeedback(document.getElementById(`fb-${idx}`), "¬°Correcto!", "success", 3000);
    } else {
        registerAction(exerciseId, 'failure');
        renderTable(); 
        showFeedback(document.getElementById(`fb-${idx}`), "Incorrecto", "error", 3000);
    }
}

function checkColors(idx) {
    const exerciseId = exercises[idx].id;
    const targetBands = exercises[idx].b;
    const feedbackElem = document.getElementById(`fb-${idx}`);
    
    let missingCount = 0;
    let selectedValues = [];

    for (let b = 0; b < 3; b++) {
        const val = document.getElementById(`user-col-${idx}-${b}`).value;
        if (!val) missingCount++;
        selectedValues.push(val);
    }

    if (missingCount > 0) {
        const msg = (missingCount === 3) ? "Faltan los 3 colores" :
                    (missingCount === 2) ? "Faltan 2 colores" : 
                    "Falta 1 color";
        showFeedback(feedbackElem, msg, "info", 2000);
        return;
    }

    let isCorrect = true;
    for (let b = 0; b < 3; b++) {
        if (selectedValues[b] !== targetBands[b]) { isCorrect = false; break; }
    }

    if (isCorrect) {
        registerAction(exerciseId, 'success');
        renderTable();
        showFeedback(document.getElementById(`fb-${idx}`), "¬°Correcto!", "success", 3000);
    } else {
        registerAction(exerciseId, 'failure');
        renderTable();
        showFeedback(document.getElementById(`fb-${idx}`), "Incorrecto", "error", 3000);
    }
}

function showFeedback(elem, text, type, duration) {
    if(!elem) return;
    elem.innerHTML = text;
    if(type === 'success') elem.className = "feedback correct";
    else if(type === 'error') elem.className = "feedback incorrect";
    else elem.className = "feedback info";
    elem.classList.remove('fade-out'); 
    
    setTimeout(() => {
        elem.classList.add('fade-out'); 
        setTimeout(() => { elem.innerHTML = ""; elem.className = "feedback"; }, 500); 
    }, duration);
}

function showReport() {
    const modal = document.getElementById('reportModal');
    const totalSolved = stats.solvedTasks.size;
    const totalViewed = stats.viewedTasks.size;
    const totalFailed = stats.failedTasks.size;
    const totalPending = TOTAL_TASKS - stats.attemptedTasks.size;
    
    const progressPct = Math.round((totalSolved / TOTAL_TASKS) * 100);
    const viewedPct = Math.round((totalViewed / TOTAL_TASKS) * 100);
    const failedPct = Math.round((totalFailed / TOTAL_TASKS) * 100);

    document.getElementById('txt-progress').innerText = `${totalSolved}/${TOTAL_TASKS}`;
    document.getElementById('bar-progress').style.width = `${progressPct}%`;
    
    document.getElementById('txt-cheated').innerText = totalViewed;
    document.getElementById('bar-cheated').style.width = `${viewedPct}%`;

    document.getElementById('txt-failed').innerText = totalFailed;
    document.getElementById('bar-failed').style.width = `${failedPct}%`;

    document.getElementById('val-completed').innerText = totalSolved;
    document.getElementById('val-viewed').innerText = totalViewed;
    document.getElementById('val-failed').innerText = totalFailed;
    document.getElementById('val-pending').innerText = totalPending;

    modal.style.display = 'flex';
}

function closeReport() { document.getElementById('reportModal').style.display = 'none'; }

window.onload = renderTable;
</script>

</body>
</html>